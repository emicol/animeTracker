#!/bin/bash

# üéå Anime History Tracker - Guide de publication extension GitHub
# Publie l'extension sur GitHub et la rend installable

set -e

# Couleurs
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
NC='\033[0m'

log() { printf "${GREEN}[$(date +'%H:%M:%S')]${NC} %s\n" "$1"; }
info() { printf "${BLUE}[INFO]${NC} %s\n" "$1"; }
warn() { printf "${YELLOW}[WARN]${NC} %s\n" "$1"; }
error() { printf "${RED}[ERROR]${NC} %s\n" "$1"; exit 1; }
header() { printf "\n${PURPLE}=== %s ===${NC}\n\n" "$1"; }

# Pr√©parer l'extension pour publication
prepare_extension() {
    header "üì¶ Pr√©paration de l'extension pour publication"
    
    # V√©rifier qu'on est dans le bon r√©pertoire
    if [ ! -f "package.json" ] || [ ! -d "extension" ]; then
        error "‚ùå Ce script doit √™tre ex√©cut√© depuis la racine du projet anime-history-tracker"
    fi
    
    cd extension
    
    # V√©rifier les fichiers essentiels
    required_files=("manifest.json" "background.js" "content.js" "popup.html" "popup.js")
    for file in "${required_files[@]}"; do
        if [ ! -f "$file" ]; then
            error "‚ùå Fichier manquant: $file"
        fi
    done
    log "‚úÖ Tous les fichiers essentiels pr√©sents"
    
    # V√©rifier les ic√¥nes
    if [ ! -d "icons" ] || [ -z "$(ls -A icons 2>/dev/null)" ]; then
        warn "‚ö†Ô∏è  Ic√¥nes manquantes - g√©n√©ration automatique..."
        cd ..
        ./fix-icons.sh --generate-only
        cd extension
    fi
    log "‚úÖ Ic√¥nes v√©rifi√©es"
    
    # Corriger le manifest pour GitHub
    info "üîß Optimisation du manifest pour GitHub..."
    cat > manifest.json << 'EOF'
{
  "manifest_version": 3,
  "name": "Anime History Tracker",
  "version": "1.0.0",
  "description": "Track your anime viewing history automatically on Anime-Sama",
  
  "permissions": [
    "storage",
    "activeTab",
    "tabs",
    "alarms"
  ],
  
  "host_permissions": [
    "https://anime-sama.fr/*"
  ],
  
  "background": {
    "service_worker": "background.js"
  },
  
  "content_scripts": [
    {
      "matches": [
        "https://anime-sama.fr/catalogue/*"
      ],
      "js": ["content.js"],
      "run_at": "document_idle"
    }
  ],
  
  "action": {
    "default_popup": "popup.html",
    "default_title": "Anime History Tracker"
  },
  
  "icons": {
    "16": "icons/icon16.png",
    "32": "icons/icon32.png",
    "48": "icons/icon48.png",
    "128": "icons/icon128.png"
  },
  
  "externally_connectable": {
    "matches": [
      "https://emicol.github.io/*"
    ]
  },
  
  "homepage_url": "https://github.com/emicol/animeTracker",
  "author": "emicol"
}
EOF
    log "‚úÖ Manifest optimis√© pour GitHub"
    
    cd ..
}

# Cr√©er une release GitHub
create_github_release() {
    header "üöÄ Cr√©ation d'une release GitHub"
    
    # Mettre √† jour la version
    info "üìÖ Mise √† jour de la version..."
    ./update-version.sh
    
    # Cr√©er le package extension
    info "üì¶ Cr√©ation du package extension..."
    cd extension
    
    # Version depuis le manifest
    VERSION=$(grep '"version"' manifest.json | sed 's/.*"version": "\([^"]*\)".*/\1/')
    
    # Cr√©er l'archive ZIP
    ZIP_NAME="anime-tracker-extension-v${VERSION}.zip"
    zip -r "../dist/$ZIP_NAME" . -x "*.zip" "node_modules/*" ".git/*" "*.md"
    
    log "‚úÖ Extension packag√©e: dist/$ZIP_NAME"
    
    cd ..
    
    # Cr√©er le tag et la release
    info "üè∑Ô∏è  Cr√©ation du tag Git..."
    git add .
    git commit -m "üîñ Release extension v$VERSION

üì¶ Extension pr√™te pour installation
üéå Compatible Anime-Sama.fr
‚ú® Tracking automatique + PWA sync" || true
    
    git tag "extension-v$VERSION" || warn "‚ö†Ô∏è  Tag d√©j√† existant"
    git push origin main
    git push origin "extension-v$VERSION" || warn "‚ö†Ô∏è  Tag d√©j√† pouss√©"
    
    log "‚úÖ Release v$VERSION cr√©√©e sur GitHub"
    
    echo ""
    echo "üéâ EXTENSION PUBLI√âE SUR GITHUB!"
    echo "================================"
    echo "üì¶ Fichier: dist/$ZIP_NAME"
    echo "üè∑Ô∏è  Version: $VERSION"
    echo "üîó GitHub: https://github.com/emicol/animeTracker/releases"
    echo ""
}

# Cr√©er les instructions d'installation
create_installation_guide() {
    header "üìö Cr√©ation du guide d'installation"
    
    cat > EXTENSION_INSTALL.md << 'EOF'
# üéå Installation Extension Anime History Tracker

## üì• T√©l√©chargement

1. **T√©l√©chargez** la derni√®re version depuis [GitHub Releases](https://github.com/emicol/animeTracker/releases)
2. **Cherchez** le fichier `anime-tracker-extension-vX.X.X.zip`
3. **T√©l√©chargez** le fichier ZIP

## üîß Installation Chrome/Brave

### M√©thode 1: Installation directe (Recommand√©e)

1. **Ouvrez** votre navigateur (Chrome/Brave/Edge)
2. **Allez** dans `chrome://extensions/` (ou `brave://extensions/`)
3. **Activez** le "Mode d√©veloppeur" (coin sup√©rieur droit)
4. **Cliquez** sur "Charger l'extension non empaquet√©e"
5. **S√©lectionnez** le dossier d√©compress√© de l'extension
6. **L'extension** appara√Æt dans la barre d'outils ! üéâ

### M√©thode 2: Depuis le ZIP

1. **D√©compressez** le fichier ZIP t√©l√©charg√©
2. **Suivez** les √©tapes de la m√©thode 1

## ‚úÖ V√©rification

1. **Visitez** [Anime-Sama.fr](https://anime-sama.fr)
2. **Regardez** un √©pisode d'anime
3. **Cliquez** sur l'ic√¥ne extension (üéå)
4. **V√©rifiez** que vos animes apparaissent

## üåê Utilisation avec la PWA

1. **Ouvrez** [Anime Tracker PWA](https://emicol.github.io/animeTracker/)
2. **L'extension** se connecte automatiquement
3. **Profitez** de votre historique complet ! üìä

## üîß D√©pannage

### Extension non d√©tect√©e
- ‚úÖ V√©rifiez que l'extension est **activ√©e**
- ‚úÖ **Rechargez** la page Anime-Sama
- ‚úÖ **Consultez** la console d√©veloppeur (F12)

### Historique vide
- ‚úÖ **Regardez** au moins 30 secondes d'un √©pisode
- ‚úÖ **V√©rifiez** que vous √™tes sur `anime-sama.fr/catalogue/`

### PWA non connect√©e
- ‚úÖ **Actualisez** la page PWA
- ‚úÖ **V√©rifiez** que l'extension est install√©e et active

## üì± Versions disponibles

- üîß **Extension navigateur** (cette installation)
- üåê **PWA** ‚Üí [emicol.github.io/animeTracker](https://emicol.github.io/animeTracker/)
- üì± **APK mobile** ‚Üí Releases GitHub

---

üí° **Besoin d'aide ?** ‚Üí [Issues GitHub](https://github.com/emicol/animeTracker/issues)
EOF
    
    log "‚úÖ Guide d'installation cr√©√©: EXTENSION_INSTALL.md"
}

# Cr√©er un serveur de d√©veloppement pour tester l'installation
create_dev_server() {
    header "üß™ Serveur de test d'installation"
    
    cat > serve-extension.js << 'EOF'
const http = require('http');
const fs = require('fs');
const path = require('path');

const PORT = 8081;

const server = http.createServer((req, res) => {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    
    if (req.url === '/') {
        // Page d'installation
        res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
        res.end(`
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéå Installation Extension Anime Tracker</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .download-btn {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            margin: 10px 5px;
        }
        .step {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
        }
        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéå Anime History Tracker - Installation Extension</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è  Mode d√©veloppeur requis</strong><br>
            Cette extension n'est pas encore sur le Chrome Web Store. 
            L'installation n√©cessite le mode d√©veloppeur.
        </div>
        
        <h2>üì• √âtape 1: T√©l√©charger</h2>
        <p>T√©l√©chargez la derni√®re version de l'extension:</p>
        <a href="/download" class="download-btn">üì¶ T√©l√©charger Extension ZIP</a>
        <a href="https://github.com/emicol/animeTracker/releases" class="download-btn">üîó GitHub Releases</a>
        
        <h2>üîß √âtape 2: Installation</h2>
        
        <div class="step">
            <strong>1.</strong> D√©compressez le fichier ZIP t√©l√©charg√©
        </div>
        
        <div class="step">
            <strong>2.</strong> Ouvrez <code>chrome://extensions/</code> dans votre navigateur
        </div>
        
        <div class="step">
            <strong>3.</strong> Activez le "Mode d√©veloppeur" (coin sup√©rieur droit)
        </div>
        
        <div class="step">
            <strong>4.</strong> Cliquez "Charger l'extension non empaquet√©e"
        </div>
        
        <div class="step">
            <strong>5.</strong> S√©lectionnez le dossier d√©compress√©
        </div>
        
        <h2>‚úÖ √âtape 3: Test</h2>
        <p>1. Visitez <a href="https://anime-sama.fr" target="_blank">Anime-Sama.fr</a></p>
        <p>2. Regardez un √©pisode d'anime</p>
        <p>3. Cliquez sur l'ic√¥ne extension üéå</p>
        <p>4. Ouvrez la <a href="https://emicol.github.io/animeTracker/" target="_blank">PWA</a></p>
        
        <h2>üöÄ Liens utiles</h2>
        <a href="https://emicol.github.io/animeTracker/" class="download-btn">üåê Ouvrir PWA</a>
        <a href="https://github.com/emicol/animeTracker" class="download-btn">üìö Documentation</a>
    </div>
</body>
</html>
        `);
    } else if (req.url === '/download') {
        // T√©l√©chargement de l'extension
        const zipFiles = fs.readdirSync('dist').filter(f => f.includes('extension') && f.endsWith('.zip'));
        
        if (zipFiles.length > 0) {
            const latestZip = zipFiles.sort().reverse()[0];
            const zipPath = path.join('dist', latestZip);
            
            res.writeHead(200, {
                'Content-Type': 'application/zip',
                'Content-Disposition': `attachment; filename="${latestZip}"`
            });
            
            fs.createReadStream(zipPath).pipe(res);
            console.log(`üì¶ Extension t√©l√©charg√©e: ${latestZip}`);
        } else {
            res.writeHead(404, { 'Content-Type': 'text/plain' });
            res.end('Extension ZIP non trouv√©e');
        }
    } else {
        res.writeHead(404, { 'Content-Type': 'text/plain' });
        res.end('404 - Page non trouv√©e');
    }
});

server.listen(PORT, () => {
    console.log(`üöÄ Serveur d'installation extension: http://localhost:${PORT}`);
    console.log(`üì¶ Instructions d'installation disponibles`);
    console.log(`üéå Testez l'installation depuis cette page`);
});
EOF
    
    log "‚úÖ Serveur de test cr√©√©: serve-extension.js"
    
    # D√©marrer le serveur si demand√©
    read -p "üöÄ Voulez-vous d√©marrer le serveur de test maintenant ? [y/N]: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        info "üåê D√©marrage du serveur..."
        node serve-extension.js &
        SERVER_PID=$!
        
        # Ouvrir dans le navigateur
        if command -v xdg-open >/dev/null 2>&1; then
            xdg-open "http://localhost:8081" 2>/dev/null &
        fi
        
        echo ""
        echo "üéâ SERVEUR DE TEST ACTIF!"
        echo "========================"
        echo "üåê URL: http://localhost:8081"
        echo "üì¶ T√©l√©chargement: http://localhost:8081/download"
        echo "‚èπÔ∏è  Arr√™ter: Ctrl+C ou kill $SERVER_PID"
        echo ""
        
        wait $SERVER_PID
    fi
}

# Fonction principale
main() {
    clear
    printf "${PURPLE}%s\n" "üéå ANIME HISTORY TRACKER - PUBLICATION EXTENSION"
    printf "%s\n" "=================================================="
    printf "${NC}\n"
    
    echo "Ce script va:"
    echo "  1. üì¶ Pr√©parer l'extension pour publication"
    echo "  2. üöÄ Cr√©er une release GitHub avec ZIP"
    echo "  3. üìö G√©n√©rer les instructions d'installation"
    echo "  4. üß™ Cr√©er un serveur de test d'installation"
    echo ""
    
    read -p "Continuer ? [y/N]: " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Op√©ration annul√©e."
        exit 0
    fi
    
    prepare_extension
    create_github_release
    create_installation_guide
    create_dev_server
    
    echo ""
    echo "üéâ EXTENSION PUBLI√âE AVEC SUCC√àS!"
    echo "================================="
    echo ""
    echo "üìã PROCHAINES √âTAPES:"
    echo "  1. üîó Visitez: https://github.com/emicol/animeTracker/releases"
    echo "  2. üì¶ Partagez le lien de t√©l√©chargement"
    echo "  3. üìö Utilisez EXTENSION_INSTALL.md comme guide"
    echo "  4. üß™ Testez avec le serveur local"
    echo ""
    echo "üí° L'extension est maintenant installable par n'importe qui !"
}

# Lancement
main "$@"
